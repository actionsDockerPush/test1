# 使用 Ubuntu 22.04 作为基础镜像
FROM ubuntu:22.04

# 设置环境变量以避免交互式提示
ENV DEBIAN_FRONTEND=noninteractive

# 更新包列表并安装必要的软件包
RUN apt-get update && apt-get install -y \
    sudo \
    wget \
    unzip \
    xorg \
    xfce4 \
    xfce4-goodies \
    tightvncserver \
    libglib2.0-0 \
    libsm6 \
    libxrender1 \
    libxext6 \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# 创建用户（例如：matlabuser）并设置密码
RUN useradd -m matlabuser && echo "matlabuser:password" | chpasswd && adduser matlabuser sudo

# 设置 USER 和 HOME 环境变量
ENV USER=matlabuser
ENV HOME=/home/matlabuser

# 切换到 matlabuser 用户
USER matlabuser
WORKDIR /home/matlabuser

# 设置 VNC 密码
RUN mkdir ~/.vnc
RUN echo "password" | vncpasswd -f > ~/.vnc/passwd && chmod 600 ~/.vnc/passwd

# 配置 xstartup 脚本以启动 XFCE4
RUN echo '#!/bin/bash\n\
xrdb $HOME/.Xresources\n\
startxfce4 &' > ~/.vnc/xstartup && chmod +x ~/.vnc/xstartup

# 创建启动脚本 start.sh
RUN echo '#!/bin/bash\n\
tightvncserver :1 -geometry 1920x1080 -depth 24\n\
tail -F /dev/null' > /home/matlabuser/start.sh && chmod +x /home/matlabuser/start.sh

# 手动安装最新 Firefox
RUN wget -O /tmp/firefox.tar.bz2 https://download.mozilla.org/?product=firefox-latest&os=linux64&lang=zh-CN \
    && tar xjf /tmp/firefox.tar.bz2 -C /opt/ \
    && ln -s /opt/firefox/firefox /usr/local/bin/firefox \
    && rm /tmp/firefox.tar.bz2

# 暴露 VNC 端口
EXPOSE 5901

# 设置启动命令
CMD ["./start.sh"]
