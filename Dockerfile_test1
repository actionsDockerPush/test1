# 使用 Ubuntu 22.04 作为基础镜像
FROM ubuntu:22.04

# 设置环境变量以避免交互式提示
ENV DEBIAN_FRONTEND=noninteractive

# 更新包列表并安装必要的软件包
RUN apt-get update && apt-get install -y \
    sudo \
    wget \
    unzip \
    xorg \
    xfce4 \
    xfce4-goodies \
    tightvncserver \
    libglib2.0-0 \
    libsm6 \
    libxrender1 \
    libxext6 \
    ca-certificates \
    gnupg \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# 配置 Mozilla APT 仓库
RUN echo '
Package: *
Pin: origin packages.mozilla.org
Pin-Priority: 1000
' > /etc/apt/preferences.d/mozilla

RUN install -d -m 0755 /etc/apt/keyrings \
    && wget -q https://packages.mozilla.org/apt/repo-signing-key.gpg -O- | tee /etc/apt/keyrings/packages.mozilla.org.asc > /dev/null \
    && echo "deb [signed-by=/etc/apt/keyrings/packages.mozilla.org.asc] https://packages.mozilla.org/apt mozilla main" > /etc/apt/sources.list.d/mozilla.list

# 更新包列表并安装 Firefox
RUN apt-get update && apt-get install -y firefox \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# 创建用户 matlabuser 并设置密码
RUN useradd -m matlabuser && echo "matlabuser:password" | chpasswd && adduser matlabuser sudo

# 设置 USER 和 HOME 环境变量
ENV USER=matlabuser
ENV HOME=/home/matlabuser

# 切换到 matlabuser 用户
USER matlabuser
WORKDIR /home/matlabuser

# 设置 VNC 密码
RUN mkdir ~/.vnc \
    && echo "password" | vncpasswd -f > ~/.vnc/passwd \
    && chmod 600 ~/.vnc/passwd

# 配置 xstartup 脚本以启动 XFCE4
RUN echo '#!/bin/bash
xrdb $HOME/.Xresources
startxfce4 &' > ~/.vnc/xstartup && chmod +x ~/.vnc/xstartup

# 创建启动脚本 start.sh
RUN echo '#!/bin/bash
tightvncserver :1 -geometry 1920x1080 -depth 24
tail -F /dev/null' > /home/matlabuser/start.sh && chmod +x /home/matlabuser/start.sh

# 暴露 VNC 端口
EXPOSE 5901

# 设置启动命令
CMD ["./start.sh"]
